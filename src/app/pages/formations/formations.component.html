<div class="formations-wrapper">
  <!-- Hero Section -->
  <section class="hero-small">
    <div class="container">
      <h1>Nos Formations Certifiantes</h1>
      <p>Des formations adaptées à votre niveau et vos besoins professionnels</p>
    </div>
  </section>

  <div class="container formations-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-search-section">
        <h3>Rechercher</h3>
        <div class="search-group">
          <label>Formation</label>
          <div class="input-wrapper">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              placeholder="Ex: Pasteurisation..."
              class="search-input"
            >
            <span class="search-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </span>
          </div>
        </div>

        <div class="search-group">
          <label>Formateur</label>
          <div class="input-wrapper">
            <input
              type="text"
              [(ngModel)]="searchInstructor"
              placeholder="Ex: Jean Dupont..."
              class="search-input"
            >
             <span class="search-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </span>
          </div>
        </div>
      </div>

      <div class="sidebar-header">
        <h3>Catégories</h3>
      </div>

      <div class="sidebar-menu">
        @for (cat of sidebarCategories; track cat.id) {
          <div class="category-item" [class.active-category]="selectedCategory === cat.id">
            <div class="category-header" (click)="toggleCategory(cat)">
              <div class="category-label-group" (click)="selectCategory(cat.id); $event.stopPropagation()">
                <span class="category-name">{{ cat.label }}</span>
              </div>
              @if (cat.subcategories.length > 0) {
                <span class="toggle-icon" [class.open]="cat.isOpen">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </span>
              }
            </div>

            @if (cat.subcategories.length > 0 && cat.isOpen) {
              <div class="subcategory-list">
                @for (sub of cat.subcategories; track sub.id) {
                  <div class="subcategory-item"
                       [class.active]="selectedSubCategory === sub.id"
                       (click)="selectSubCategory(cat.id, sub.id, $event)">
                    {{ sub.label }}
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="alert alert-warning" style="margin-bottom: 1.5rem; padding: 1rem; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404;">
          <strong>⚠️ Attention:</strong> {{ errorMessage() }}
        </div>
      }

      <!-- Loading State -->
      @if (isLoadingFormations()) {
        <div class="loading-state" style="text-align: center; padding: 3rem;">
          <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
          <p>Chargement des formations...</p>
        </div>
      }

      @if (!isLoadingFormations()) {
        <div class="results-header">
          <h2>{{ getCategoryLabel(selectedCategory) }}</h2>
          <span class="results-count">{{ getFilteredCourses().length }} formation(s)</span>
        </div>

        @if (getFilteredCourses().length > 0) {
          <div class="formations-grid">
          @for (course of getFilteredCourses(); track course.id) {
            <div class="formation-card">
              <!-- Course Image -->
              <div class="formation-image">
                @if (course.image) {
                  <img [src]="course.image" [alt]="course.title" />
                } @else {
                  <div class="formation-placeholder">
                    @switch(getCategoryIcon(course.category)) {
                      @case('automation') {
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="1"></circle>
                          <path d="M12 1v6m6-1h-5M6 8H1m17 6h5M8 12H3m13 0h5M6 20h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2z"></path>
                        </svg>
                      }
                      @case('thermo') {
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path>
                        </svg>
                      }
                      @case('process') {
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"></path>
                        </svg>
                      }
                      @default {
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                      }
                    }
                  </div>
                }
                <div class="formation-overlay">
                  <span class="category-badge" [class]="'category-' + course.category">
                    {{ getCategoryLabel(course.category) }}
                  </span>
                  @if (course.access_key === 'open') {
                    <span class="access-badge available">✓ Disponible</span>
                  } @else {
                    <span class="access-badge coming-soon">Bientôt</span>
                  }
                </div>
              </div>

              <!-- Course Content -->
              <div class="formation-content">
                <div class="formation-header">
                  <h3 class="formation-title">{{ course.title }}</h3>
                  <div class="formation-meta">
                    <span class="level-badge" [class]="'level-' + (course.level || 'all').toLowerCase().replace(' ', '-')">
                      {{ course.level || 'Tous niveaux' }}
                    </span>
                    <span class="duration-badge">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                      </svg>
                      {{ formatDuration(course.total_duration) }}
                    </span>
                  </div>
                </div>

                <p class="formation-description">{{ course.description }}</p>

                <div class="formation-footer">
                  @if (course.access_key === 'open') {
                    <a [routerLink]="['/course', course.id]" class="btn-primary">
                      Découvrir
                    </a>
                  } @else {
                    <button class="btn-secondary" disabled>
                      Bientôt disponible
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>
        } @else {
          <div class="empty-state">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </div>
            <h2>Aucune formation trouvée</h2>
            <p>Essayez de sélectionner une autre catégorie.</p>
          </div>
        }
      }
    </main>
  </div>

  <!-- CTA Section -->
  <section class="section cta-section">
    <div class="container">
      <div class="cta-content text-center">
        <h2>Besoin d'Informations Supplémentaires ?</h2>
        <p>Contactez-nous pour discuter de vos besoins de formation et recevoir un devis personnalisé.</p>
        <div class="cta-buttons">
          <a routerLink="/contact" class="btn btn-primary btn-lg">Nous Contacter</a>
          <a routerLink="/login" class="btn btn-secondary btn-lg">Connexion Étudiant</a>
        </div>
      </div>
    </div>
  </section>
</div>
